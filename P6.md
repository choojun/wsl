# PRACTICAL 6: MapReduce (MR)

~~~ As the user hduser ~~~

Ensure that the hadoop services that are running.

Change ownership and permissions for the /tmp directory in HDFS
List the current permissions of the root directory directory
hduser@PC25:~$ hdfs dfs -ls /                                                             Found 3 items                                                                             drwxr-xr-x  - hduser supergroup    0 2024-08-15 10:15 /hbase                       
drwxrwxr-x  - hduser supergroup    0 2024-08-15 11:04 /tmp                         
drwxrwxr-x  - hduser supergroup    0 2024-08-15 08:08 /user

Change the ownership of the /tmp directory to hduser:hduser

Change the permission of the /tmp directory to drwxrwxr-x 

~~~ As the user student ~~~

MR Job Example: Filtering Files Containing a Word Pattern

Prepare data files in HDFS
student@PC25:~$ hdfs dfs -mkdir input
student@PC25:~$ hdfs dfs -put $HADOOP_HOME/etc/hadoop/*xml input
üóπ Check the list of files in the input directory.
capacity-scheduler.xml                                                   core-site.xml                                                            hadoop-policy.xml                                                        hdfs-rbf-site.xml                                                        hdfs-site.xml                                                            httpfs-site.xml                                                          kms-acls.xml                                                             kms-site.xml                                                             mapred-site.xml                                                          yarn-site.xml 

Run the MR job to filter files containing the prefix ‚Äúdfs‚Äù:
student@PC25:~$ hadoop jar $HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.6.jar grep input output 'dfs[a-z.]+'
2024-08-13 09:18:21,413 INFO client.DefaultNoHARMFailoverProxyProvider: Connecting to ResourceManager at /127.0.0.1:8032                    2024-08-13 09:18:21,690 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding for path: /tmp/hadoop-yarn/staging/student/.staging/job_1723507517701_0001                                                                                                                          2024-08-13 09:18:21,887 INFO input.FileInputFormat: Total input files to process : 10                                                       2024-08-13 09:18:21,925 INFO mapreduce.JobSubmitter: number of splits:10                                                                    2024-08-13 09:18:22,015 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1723507517701_0001                                      2024-08-13 09:18:22,015 INFO mapreduce.JobSubmitter: Executing with tokens: []                                                              2024-08-13 09:18:22,120 INFO conf.Configuration: resource-types.xml not found                                                               2024-08-13 09:18:22,120 INFO resource.ResourceUtils: Unable to find 'resource-types.xml'.                                                   2024-08-13 09:18:22,587 INFO impl.YarnClientImpl: Submitted application application_1723507517701_0001                                      2024-08-13 09:18:22,614 INFO mapreduce.Job: The url to track the job: http://PC25.:8088/proxy/application_1723507517701_0001/               2024-08-13 09:18:22,615 INFO mapreduce.Job: Running job: job_1723507517701_0001                                                             2024-08-13 09:18:28,681 INFO mapreduce.Job: Job job_1723507517701_0001 running in uber mode : false                                         2024-08-13 09:18:28,684 INFO mapreduce.Job:  map 0% reduce 0%                                                                               2024-08-13 09:18:32,719 INFO mapreduce.Job:  map 60% reduce 0%                                                                              2024-08-13 09:18:35,734 INFO mapreduce.Job:  map 100% reduce 0%                                                                             2024-08-13 09:18:37,752 INFO mapreduce.Job:  map 100% reduce 100%                                                                           2024-08-13 09:18:37,765 INFO mapreduce.Job: Job job_1723507517701_0001 completed successfully                                               2024-08-13 09:18:37,810 INFO mapreduce.Job: Counters: 54                                                                                            File System Counters                                                                                                                                FILE: Number of bytes read=115                                                                                                              FILE: Number of bytes written=3043456                                                                                                       FILE: Number of read operations=0                                                                                                           FILE: Number of large read operations=0                                                                                                     FILE: Number of write operations=0                                                                                                          HDFS: Number of bytes read=32110                                                                                                            HDFS: Number of bytes written=219                                                                                                           HDFS: Number of read operations=35                                                                                                          HDFS: Number of large read operations=0                                                                                                     HDFS: Number of write operations=2                                                                                                          HDFS: Number of bytes read erasure-coded=0                                                                                          Job Counters                                                                                                                                        Launched map tasks=10                                                                                                                       Launched reduce tasks=1                                                                                                                     Data-local map tasks=10                                                                                                                     Total time spent by all maps in occupied slots (ms)=21127                                                                                   Total time spent by all reduces in occupied slots (ms)=1515                                                                                 Total time spent by all map tasks (ms)=21127                                                                                                Total time spent by all reduce tasks (ms)=1515                                                                                              Total vcore-milliseconds taken by all map tasks=21127                                                                                       Total vcore-milliseconds taken by all reduce tasks=1515                                                                                     Total megabyte-milliseconds taken by all map tasks=21634048                                                                                 Total megabyte-milliseconds taken by all reduce tasks=1551360                                                                       Map-Reduce Framework                                                                                                                                Map input records=835                                                                                                                       Map output records=4                                                                                                                        Map output bytes=101                                                                                                                        Map output materialized bytes=169                                                                                                           Input split bytes=1199                                                                                                                      Combine input records=4                                                                                                                     Combine output records=4                                                                                                                    Reduce input groups=4                                                                                                                       Reduce shuffle bytes=169                                                                                                                    Reduce input records=4                                                                                                                      Reduce output records=4                                                                                                                     Spilled Records=8                                                                                                                           Shuffled Maps =10                                                                                                                           Failed Shuffles=0                                                                                                                           Merged Map outputs=10                                                                                                                       GC time elapsed (ms)=763                                                                                                                    CPU time spent (ms)=3920                                                                                                                    Physical memory (bytes) snapshot=3937648640                                                                                                 Virtual memory (bytes) snapshot=28513394688                                                                                                 Total committed heap usage (bytes)=7126646784                                                                                               Peak Map Physical memory (bytes)=364609536                                                                                                  Peak Map Virtual memory (bytes)=2592559104                                                                                                  Peak Reduce Physical memory (bytes)=343212032                                                                                               Peak Reduce Virtual memory (bytes)=2598748160                                                                                       Shuffle Errors                                                                                                                                      BAD_ID=0                                                                                                                                    CONNECTION=0                                                                                                                                IO_ERROR=0                                                                                                                                  WRONG_LENGTH=0                                                                                                                              WRONG_MAP=0                                                                                                                                 WRONG_REDUCE=0                                                                                                                      File Input Format Counters                                                                                                                          Bytes Read=30911                                                                                                                    File Output Format Counters                                                                                                                         Bytes Written=219                                                                                                           2024-08-13 09:18:37,828 INFO client.DefaultNoHARMFailoverProxyProvider: Connecting to ResourceManager at /127.0.0.1:8032                    2024-08-13 09:18:37,847 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding for path: /tmp/hadoop-yarn/staging/student/.staging/job_1723507517701_0002                                                                                                                          2024-08-13 09:18:37,870 INFO input.FileInputFormat: Total input files to process : 1                                                        2024-08-13 09:18:37,896 INFO mapreduce.JobSubmitter: number of splits:1                                                                     2024-08-13 09:18:37,928 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1723507517701_0002                                      2024-08-13 09:18:37,928 INFO mapreduce.JobSubmitter: Executing with tokens: []                                                              2024-08-13 09:18:37,942 INFO impl.YarnClientImpl: Submitted application application_1723507517701_0002                                      2024-08-13 09:18:37,945 INFO mapreduce.Job: The url to track the job: http://PC25.:8088/proxy/application_1723507517701_0002/               2024-08-13 09:18:37,945 INFO mapreduce.Job: Running job: job_1723507517701_0002                                                             2024-08-13 09:18:47,014 INFO mapreduce.Job: Job job_1723507517701_0002 running in uber mode : false                                         2024-08-13 09:18:47,015 INFO mapreduce.Job:  map 0% reduce 0%                                                                               2024-08-13 09:18:51,045 INFO mapreduce.Job:  map 100% reduce 0%                                                                             2024-08-13 09:18:55,059 INFO mapreduce.Job:  map 100% reduce 100%                                                                           2024-08-13 09:18:55,064 INFO mapreduce.Job: Job job_1723507517701_0002 completed successfully                                               2024-08-13 09:18:55,084 INFO mapreduce.Job: Counters: 54                                                                                            File System Counters                                                                                                                                FILE: Number of bytes read=115                                                                                                              FILE: Number of bytes written=552331                                                                                                        FILE: Number of read operations=0                                                                                                           FILE: Number of large read operations=0                                                                                                     FILE: Number of write operations=0                                                                                                          HDFS: Number of bytes read=350                                                                                                              HDFS: Number of bytes written=77                                                                                                            HDFS: Number of read operations=9                                                                                                           HDFS: Number of large read operations=0                                                                                                     HDFS: Number of write operations=2                                                                                                          HDFS: Number of bytes read erasure-coded=0                                                                                          Job Counters                                                                                                                                        Launched map tasks=1                                                                                                                        Launched reduce tasks=1                                                                                                                     Data-local map tasks=1                                                                                                                      Total time spent by all maps in occupied slots (ms)=1331                                                                                    Total time spent by all reduces in occupied slots (ms)=1370                                                                                 Total time spent by all map tasks (ms)=1331                                                                                                 Total time spent by all reduce tasks (ms)=1370                                                                                              Total vcore-milliseconds taken by all map tasks=1331                                                                                        Total vcore-milliseconds taken by all reduce tasks=1370                                                                                     Total megabyte-milliseconds taken by all map tasks=1362944                                                                                  Total megabyte-milliseconds taken by all reduce tasks=1402880                                                                       Map-Reduce Framework                                                                                                                                Map input records=4                                                                                                                         Map output records=4                                                                                                                        Map output bytes=101                                                                                                                        Map output materialized bytes=115                                                                                                           Input split bytes=131                                                                                                                       Combine input records=0                                                                                                                     Combine output records=0                                                                                                                    Reduce input groups=1                                                                                                                       Reduce shuffle bytes=115                                                                                                                    Reduce input records=4                                                                                                                      Reduce output records=4                                                                                                                     Spilled Records=8                                                                                                                           Shuffled Maps =1                                                                                                                            Failed Shuffles=0                                                                                                                           Merged Map outputs=1                                                                                                                        GC time elapsed (ms)=52                                                                                                                     CPU time spent (ms)=590                                                                                                                     Physical memory (bytes) snapshot=705335296                                                                                                  Virtual memory (bytes) snapshot=5190762496                                                                                                  Total committed heap usage (bytes)=1261961216                                                                                               Peak Map Physical memory (bytes)=359088128                                                                                                  Peak Map Virtual memory (bytes)=2590969856                                                                                                  Peak Reduce Physical memory (bytes)=346247168                                                                                               Peak Reduce Virtual memory (bytes)=2599792640                                                                                       Shuffle Errors                                                                                                                                      BAD_ID=0                                                                                                                                    CONNECTION=0                                                                                                                                IO_ERROR=0                                                                                                                                  WRONG_LENGTH=0                                                                                                                              WRONG_MAP=0                                                                                                                                 WRONG_REDUCE=0                                                                                                                      File Input Format Counters                                                                                                                          Bytes Read=219                                                                                                                      File Output Format Counters                                                                                                                         Bytes Written=77  
 
Check the results:
student@PC25:~$ hdfs dfs -cat output/*
1       dfsadmin                                                                                                                            1       dfs.replication                                                                                                                     1       dfs.namenode.name.dir                                                                                                               1       dfs.datanode.data.dir 



~~~ As the user student ~~~

MR Job Example: Word Count Example
(Adapted from reference)

Copy the wordcount folder to the home directory of student in the local file system.

Change ownership of the wordcount folder in the local file system to student:hduser.

Change directory to the wordcount folder in the local file system.

Change the file permissions of mapper.py and reducer.py in the local file system so that they are executable.
student@PC25:~$ sudo chmod +x mapper.py
student@PC25:~$ sudo chmod +x reducer.py

Create a directory named wordcount in HDFS. 

Copy weather.txt to the HDFS‚Äô wordcount directory

Execute the Streaming job against the cluster:
student@PC25:~/wordcount$ hadoop jar $HADOOP_HOME/share/hadoop/tools/lib/hadoop-streaming-*.jar -input wordcount/weather.txt -output wordcount/results -mapper mapper.py -reducer reducer.py -file mapper.py -file reducer.py

student@PC25:~/wordcount$ hadoop jar $HADOOP_HOME/share/hadoop/tools/lib/hadoop-streaming-*.jar -input wordcount/weather.txt -output wordcount/results -mapper mapper.py -reducer reducer.py -file mapper.py -file reducer.py                                                        2024-08-20 10:27:15,632 WARN streaming.StreamJob: -file option is deprecated, please use generic option -files instead.                     packageJobJar: [mapper.py, reducer.py, /tmp/hadoop-unjar6033976414906345783/] [] /tmp/streamjob6189985584315272003.jar tmpDir=null          2024-08-20 10:27:16,131 INFO client.DefaultNoHARMFailoverProxyProvider: Connecting to ResourceManager at /127.0.0.1:8032                    2024-08-20 10:27:16,246 INFO client.DefaultNoHARMFailoverProxyProvider: Connecting to ResourceManager at /127.0.0.1:8032                    2024-08-20 10:27:16,354 INFO mapreduce.JobResourceUploader: Disabling Erasure Coding for path: /tmp/hadoop-yarn/staging/student/.staging/job_1724112672230_0011                                                                                                                         2024-08-20 10:27:16,548 INFO mapred.FileInputFormat: Total input files to process : 1                                                       2024-08-20 10:27:16,583 INFO mapreduce.JobSubmitter: number of splits:2                                                                     2024-08-20 10:27:16,644 INFO mapreduce.JobSubmitter: Submitting tokens for job: job_1724112672230_0011                                      2024-08-20 10:27:16,645 INFO mapreduce.JobSubmitter: Executing with tokens: []                                                              2024-08-20 10:27:16,742 INFO conf.Configuration: resource-types.xml not found                                                               2024-08-20 10:27:16,742 INFO resource.ResourceUtils: Unable to find 'resource-types.xml'.                                                   2024-08-20 10:27:16,776 INFO impl.YarnClientImpl: Submitted application application_1724112672230_0011                                      2024-08-20 10:27:16,796 INFO mapreduce.Job: The url to track the job: http://PC25.:8088/proxy/application_1724112672230_0011/               2024-08-20 10:27:16,797 INFO mapreduce.Job: Running job: job_1724112672230_0011                                                             2024-08-20 10:27:20,836 INFO mapreduce.Job: Job job_1724112672230_0011 running in uber mode : false                                         2024-08-20 10:27:20,839 INFO mapreduce.Job:  map 0% reduce 0%                                                                               2024-08-20 10:27:24,877 INFO mapreduce.Job:  map 100% reduce 0%                                                                             2024-08-20 10:27:28,932 INFO mapreduce.Job:  map 100% reduce 100%                                                                           2024-08-20 10:27:28,950 INFO mapreduce.Job: Job job_1724112672230_0011 completed successfully                                               2024-08-20 10:27:28,997 INFO mapreduce.Job: Counters: 54                                                                                            File System Counters                                                                                                                                FILE: Number of bytes read=334                                                                                                              FILE: Number of bytes written=840115                                                                                                        FILE: Number of read operations=0                                                                                                           FILE: Number of large read operations=0                                                                                                     FILE: Number of write operations=0                                                                                                          HDFS: Number of bytes read=498                                                                                                              HDFS: Number of bytes written=462                                                                                                           HDFS: Number of read operations=11                                                                                                          HDFS: Number of large read operations=0                                                                                                     HDFS: Number of write operations=2                                                                                                          HDFS: Number of bytes read erasure-coded=0                                                                                          Job Counters                                                                                                                                        Launched map tasks=2                                                                                                                        Launched reduce tasks=1                                                                                                                     Data-local map tasks=2                                                                                                                      Total time spent by all maps in occupied slots (ms)=3003                                                                                    Total time spent by all reduces in occupied slots (ms)=1492                                                                                 Total time spent by all map tasks (ms)=3003                                                                                                 Total time spent by all reduce tasks (ms)=1492                                                                                              Total vcore-milliseconds taken by all map tasks=3003                                                                                        Total vcore-milliseconds taken by all reduce tasks=1492                                                                                     Total megabyte-milliseconds taken by all map tasks=3075072                                                                                  Total megabyte-milliseconds taken by all reduce tasks=1527808                                                                       Map-Reduce Framework                                                                                                                                Map input records=7                                                                                                                         Map output records=35                                                                                                                       Map output bytes=258                                                                                                                        Map output materialized bytes=340                                                                                                           Input split bytes=216                                                                                                                       Combine input records=0                                                                                                                     Combine output records=0                                                                                                                    Reduce input groups=14                                                                                                                      Reduce shuffle bytes=340                                                                                                                    Reduce input records=35                                                                                                                     Reduce output records=14                                                                                                                    Spilled Records=70                                                                                                                          Shuffled Maps =2                                                                                                                            Failed Shuffles=0                                                                                                                           Merged Map outputs=2                                                                                                                        GC time elapsed (ms)=78                                                                                                                     CPU time spent (ms)=1040                                                                                                                    Physical memory (bytes) snapshot=1066655744                                                                                                 Virtual memory (bytes) snapshot=7786926080                                                                                                  Total committed heap usage (bytes)=1880621056                                                                                               Peak Map Physical memory (bytes)=359960576                                                                                                  Peak Map Virtual memory (bytes)=2593722368                                                                                                  Peak Reduce Physical memory (bytes)=348487680                                                                                               Peak Reduce Virtual memory (bytes)=2599530496                                                                                       Shuffle Errors                                                                                                                                      BAD_ID=0                                                                                                                                    CONNECTION=0                                                                                                                                IO_ERROR=0                                                                                                                                  WRONG_LENGTH=0                                                                                                                              WRONG_MAP=0                                                                                                                                 WRONG_REDUCE=0                                                                                                                      File Input Format Counters                                                                                                                          Bytes Read=282                                                                                                                      File Output Format Counters                                                                                                                         Bytes Written=462                                                                                                           2024-08-20 10:27:28,997 INFO streaming.StreamJob: Output directory: wordcount/results 


List the contents of the HDFS‚Äô wordcount directory
$ hdfs dfs -ls wordcount


List the contents of the HDFS‚Äô wordcount/results directory
$ hdfs dfs -ls wordcount/results
Found 2 items                                                                                                                               -rw-r--r--  1 student hduser   0  2024-08-20 10:27 wordcount/results/_SUCCESS                                                  -rw-r--r--  1 student hduser 462  2024-08-20 10:27 wordcount/results/part-00000



View the content of the beginning of the part-00000 file
$ hdfs dfs -head wordcount/results/part-00000                                                                    be                              4                                                                                                           cold                            1                                                                                                           fine                            1                                                                                                           hot                             1                                                                                                           it                              1                                                                                                           like                            1                                                                                                           not                             2                                                                                                           or                              3                                                                                                           the                             6                                                                                                           we                              1                                                                                                           weather                         6                                                                                                           well                            1                                                                                                           whatever                        1                                                                                                           whether                         6  

